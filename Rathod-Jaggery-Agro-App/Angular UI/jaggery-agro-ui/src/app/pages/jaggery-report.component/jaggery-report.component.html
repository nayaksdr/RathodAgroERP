<div class="report-wrapper p-3 p-md-4 animate__animated animate__fadeIn">
  
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
      <h2 class="fw-bolder text-dark m-0 d-flex align-items-center gap-2 tracking-tight">
        <mat-icon class="text-primary fs-2">analytics</mat-icon>
        Jaggery<span class="text-primary">Sales</span> Analytics
      </h2>
      <p class="text-muted small mb-0 fw-medium">Real-time inventory and dealer settlement insights</p>
    </div>
    
    <div class="d-flex gap-2">
      <button class="btn btn-export excel shadow-sm" (click)="export('excel')">
        <mat-icon>grid_on</mat-icon> Export Excel
      </button>
      <button class="btn btn-export pdf shadow-sm" (click)="export('pdf')">
        <mat-icon>picture_as_pdf</mat-icon> PDF Report
      </button>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-4 mb-4 ribbon-card">
    <div class="card-body p-3">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="label-caps"><mat-icon>storefront</mat-icon> Associate Dealer</label>
          <div class="input-group">
            <select class="form-select border-0 bg-light-subtle rounded-3"
        [(ngModel)]="filter.dealerId">
  <option [ngValue]="undefined">All Strategic Partners</option>
  <option *ngFor="let d of dealers" [ngValue]="d.id">
    {{ d.name }}
  </option>
</select>

          </div>
        </div>

        <div class="col-md-3">
          <label class="label-caps"><mat-icon>calendar_today</mat-icon> Start Date</label>
          <input type="date" class="form-control border-0 bg-light-subtle rounded-3" [(ngModel)]="filter.from">
        </div>

        <div class="col-md-3">
          <label class="label-caps"><mat-icon>event</mat-icon> End Date</label>
          <input type="date" class="form-control border-0 bg-light-subtle rounded-3" [(ngModel)]="filter.to">
        </div>

        <div class="col-md-2">
          <label class="label-caps invisible">Action</label>
          <button class="btn btn-primary w-100 py-2 rounded-3 fw-bold shadow-sm d-flex align-items-center justify-content-center gap-2" 
                  (click)="fetchData()" [disabled]="isLoading">
            <mat-icon class="spin-icon" *ngIf="isLoading">sync</mat-icon>
            {{ isLoading ? 'FETCHING...' : 'ANALYZE' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4" *ngIf="reportData.summary">
    <div class="col-md-3" *ngFor="let m of [
      {l: 'Quantity Sold', v: reportData.summary.totalQty, u: 'Kg', i: 'scale', c: 'indigo'},
      {l: 'Gross Revenue', v: reportData.summary.totalAmount, u: '₹', i: 'payments', c: 'emerald'},
      {l: 'Advance Paid', v: reportData.summary.totalAdvance, u: '₹', i: 'account_balance_wallet', c: 'sky'},
      {l: 'Balance Due', v: reportData.summary.totalRemaining, u: '₹', i: 'hourglass_empty', c: 'amber'}
    ]">
      <div class="card border-0 shadow-sm rounded-4 metric-card {{m.c}}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="icon-circle"><mat-icon>{{m.i}}</mat-icon></div>
            <span class="label-caps m-0">{{m.l}}</span>
          </div>
          <h3 class="fw-black m-0 mt-1">
            <small class="fs-6" *ngIf="m.u === '₹'">₹</small>{{m.v | number:'1.0-0'}}<small class="fs-6 text-muted" *ngIf="m.u !== '₹'"> {{m.u}}</small>
          </h3>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-lg rounded-4 overflow-hidden bg-white">
    <div class="card-header bg-white p-3 border-0 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
      <h5 class="m-0 fw-bold text-dark">Transaction Ledger</h5>
      
      <div class="search-container">
        <mat-icon>search</mat-icon>
        <input type="text"
       placeholder="Filter by dealer or amount..."
       [(ngModel)]="searchText"
       (input)="applyFilter()">

      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th class="ps-4">Entity</th>
            <th>Date</th>
            <th>Weight</th>
            <th>Rate</th>
            <th>Net Total</th>
            <th class="text-end pe-4">Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of filteredSales" class="animate__animated animate__fadeInUp">
            <td class="ps-4">
              <div class="d-flex align-items-center gap-3">
                <div class="initial-box">{{s.dealer?.name?.charAt(0)}}</div>
                <span class="fw-bold text-dark">{{s.dealer?.name}}</span>
              </div>
            </td>
            <td class="text-secondary small">{{s.saleDate | date:'dd MMM, yyyy'}}</td>
            <td><span class="fw-semibold">{{s.quantityInKg}}</span> <span class="text-muted">kg</span></td>
            <td class="text-muted">₹{{s.ratePerKg}}</td>
            <td><span class="text-primary fw-bolder">₹{{s.totalAmount | number}}</span></td>
            <td class="text-end pe-4">
              <span class="badge-pill" [class.paid]="s.remainingAmount === 0" [class.pending]="s.remainingAmount > 0">
                <mat-icon>{{s.remainingAmount === 0 ? 'check_circle' : 'pending'}}</mat-icon>
                {{s.remainingAmount === 0 ? 'SETTLED' : 'DUE ₹' + s.remainingAmount}}
              </span>
            </td>
          </tr>
          
          <tr *ngIf="filteredSales.length === 0">
            <td colspan="6" class="text-center py-5">
              <img src="assets/img/no-data.svg" alt="" style="width: 80px; opacity: 0.5;">
              <p class="text-muted mt-3 fw-medium">No transactions found for the given criteria.</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>