<div class="jaggerySheare container-fluid py-4 animate__animated animate__fadeIn">
  
  <div class="row g-3 mb-4">
    <div class="col-md-3" *ngFor="let card of [
      {label: 'Total Sales', val: stats.totalSales, icon: 'payments', class: 'text-primary'},
      {label: 'Total Advance', val: stats.totalAdvance, icon: 'account_balance', class: 'text-success'},
      {label: 'Remaining', val: stats.totalRemaining, icon: 'pending_actions', class: 'text-warning'},
      {label: 'Total Qty', val: stats.totalQty, icon: 'inventory_2', unit: 'Bags', class: 'text-info'}
    ]">
      <div class="stat-glass-card shadow-sm p-3 d-flex align-items-center animate__animated animate__backInDown">
        <div class="icon-shape me-3" [ngClass]="card.class">
          <mat-icon>{{card.icon}}</mat-icon>
        </div>
        <div>
          <p class="text-muted small mb-0 fw-bold text-uppercase">{{card.label}}</p>
          <h4 class="fw-bold mb-0">
            {{card.unit ? '' : '₹'}}{{card.val | number}}{{card.unit ? ' ' + card.unit : ''}}
          </h4>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-xl-8">
      
      <div class="glass-card mb-4 p-4 border-start border-4 border-primary shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="fw-bold mb-0 d-flex align-items-center">
            <mat-icon class="me-2 text-primary">swap_horizontal_circle</mat-icon>
            Smart Settlement Matrix
          </h5>
          <button mat-stroked-button color="primary" (click)="printReport()">
            <mat-icon>picture_as_pdf</mat-icon> Export Report
          </button>
        </div>
        
        <div class="row">
          <div class="col-md-6" *ngFor="let pay of settlementMatrix">
            <div class="settlement-card p-3 mb-3 border-start border-4 border-primary shadow-sm bg-white rounded-4 animate__animated animate__zoomIn">
              <div class="row align-items-center">
                <div class="col-4 text-center">
                  <span class="badge bg-danger rounded-pill px-3 py-2 text-truncate d-block">{{pay.from}}</span>
                  <small class="d-block text-muted mt-1 fw-bold">PAYS</small>
                </div>
                <div class="col-4 text-center">
                  <div class="payment-arrow">
                    <span class="fw-bold text-primary">₹{{pay.amount | number}}</span>
                    <mat-icon class="d-block w-100 text-primary">trending_flat</mat-icon>
                  </div>
                </div>
                <div class="col-4 text-center">
                  <span class="badge bg-success rounded-pill px-3 py-2 text-truncate d-block">{{pay.to}}</span>
                  <small class="d-block text-muted mt-1 fw-bold">RECEIVES</small>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="settlementMatrix.length === 0" class="text-center py-4 text-muted w-100">
            <mat-icon class="fs-1 opacity-25">verified</mat-icon>
            <p class="fw-bold">All partners are settled. No dues found.</p>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-6" *ngFor="let m of memberSummary">
          <div class="partner-glass-card p-4 h-100 shadow-sm transition-hover border-0">
            <div class="d-flex justify-content-between">
              <div class="d-flex align-items-center mb-3">
                <div class="avatar-box me-3">{{m.name[0]}}</div>
                <div>
                  <h6 class="fw-bold mb-0">{{m.name}}</h6>
                  <small class="text-muted">Net Position</small>
                </div>
              </div>
              <div class="text-end">
                <h5 [ngClass]="m.netBalance < 0 ? 'text-danger' : 'text-success'" class="fw-bold mb-0">
                  {{m.netBalance < 0 ? '-' : '+'}} ₹{{Math.abs(m.netBalance) | number}}
                </h5>
                <button mat-icon-button color="primary" (click)="generateSettlementMessage(m)" matTooltip="Share Summary">
                  <mat-icon class="fs-6">share</mat-icon>
                </button>
              </div>
            </div>
            
            <div class="progress-stack mt-2">
              <div class="d-flex justify-content-between small mb-1">
                <span class="fw-bold text-muted">Recovery Rate</span>
                <span class="fw-bold">{{m.recoveryPercent | number:'1.0-0'}}%</span>
              </div>
              <div class="progress shadow-none rounded-pill" style="height: 8px;">
                <div class="progress-bar" 
                     [ngClass]="m.recoveryPercent >= 100 ? 'bg-success' : 'bg-primary'" 
                     [style.width.%]="m.recoveryPercent > 100 ? 100 : m.recoveryPercent">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="glass-card p-4 shadow-sm border-0">
        <h6 class="fw-bold mb-4 d-flex align-items-center">
          <mat-icon class="me-2 text-secondary">insights</mat-icon> Profit Flow Analytics
        </h6>
        <div class="chart-container" style="height: 300px;">
          <canvas id="mainChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-xl-4">
      
      <div class="glass-card p-4 mb-4 border-top border-4 border-info shadow-lg">
        <h5 class="fw-bold mb-4 d-flex align-items-center">
          <mat-icon class="me-2 text-info">add_moderator</mat-icon>
          Record Distribution
        </h5>
        
        <form (ngSubmit)="onSubmit()" class="custom-form">
          <div class="mb-3">
  <label class="form-label small fw-bold">Select Jaggery Sale</label>
  <div class="input-group input-group-sm">
    <span class="input-group-text bg-white border-end-0 text-muted">
      <mat-icon class="fs-6">shopping_basket</mat-icon>
    </span>
    <select class="form-select border-start-0 ps-0" 
            name="saleId" 
            [(ngModel)]="model.jaggerySaleId" 
            (change)="onSaleSelect($event)">
      <option [ngValue]="null">Choose a sale...</option>
      <option *ngFor="let s of sales" [value]="s.id">
        {{ s.displayText }}
      </option>
    </select>
  </div>
</div>

          <div class="mb-3">
            <label class="form-label small fw-bold">Amount to Distribute</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-white">₹</span>
              <input type="number" class="form-control" name="paidAmount" [(ngModel)]="model.paidAmount" (input)="calculateShare()">
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label small fw-bold d-block">Split Between Partners</label>
            <div class="d-flex flex-wrap gap-2">
              <div *ngFor="let m of members" 
                   class="partner-chip shadow-sm" 
                   [ngClass]="{'active': model.splitMemberIds.includes(m.id)}"
                   (click)="toggleMember(m.id)">
                <mat-icon class="fs-6">{{model.splitMemberIds.includes(m.id) ? 'check_circle' : 'person_outline'}}</mat-icon>
                {{m.name}}
              </div>
            </div>
            <div class="mt-3 p-2 bg-light rounded text-center text-primary fw-bold border border-primary-subtle" *ngIf="model.individualShare > 0">
              Each gets: ₹{{model.individualShare | number}}
            </div>
          </div>

          <div class="mb-4">
            <div class="upload-zone p-3 text-center border-2" (click)="fileInput.click()" [ngClass]="{'has-file': model.attachmentBase64}">
              <input type="file" #fileInput hidden (change)="onFileChange($event)">
              <mat-icon class="d-block mx-auto text-muted mb-2">{{model.attachmentBase64 ? 'task_alt' : 'cloud_upload'}}</mat-icon>
              <span class="small fw-bold">{{model.attachmentBase64 ? 'Receipt Attached' : 'Upload Bank Receipt'}}</span>
            </div>
          </div>

          <button type="submit" class="btn btn-info w-100 py-3 fw-bold text-white shadow-sm transition-hover">
            {{ isEditMode ? 'UPDATE SETTLEMENT' : 'FINALIZE & SAVE' }}
          </button>
        </form>
      </div>

      <div class="glass-card p-4 shadow-sm border-0">
        <h6 class="fw-bold mb-3 d-flex align-items-center">
          <mat-icon class="me-2 text-warning">local_shipping</mat-icon> Dealer Pending List
        </h6>
        <div *ngFor="let d of dealerBalances" class="dealer-row mb-3 pb-2 border-bottom">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="fw-bold small">{{d.name}}</span>
            <span class="badge bg-soft-warning text-warning fw-bold">₹{{d.remaining | number}}</span>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-info" [style.width.%]="d.percent"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>